<!DOCTYPE html>
<html>
<head>
    <title>Detalle - <%= paciente.nombre %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
</head>
<body>
    <a href="/pacientes">← Volver al listado</a>
    
    <h1>Historia Clínica</h1>
    <section style="background: #eef2f3; padding: 15px; border-radius: 8px;">
        <p><strong>Nombre:</strong> <%= paciente.nombre %></p>
        <p><strong>Cédula:</strong> <%= paciente.cedula %></p>
        <p><strong>Edad:</strong> <%= paciente.edad %> años</p>
        <p><strong>Fecha de Ingreso:</strong> <%= paciente.fechaIngreso.toLocaleDateString() %></p>
    </section>

    <hr>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Exámenes Realizados</h3>
        <a href="/pacientes/<%= paciente.id %>/examen/nuevo" 
           style="background: #007bff; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px; font-weight: bold;">
            + Agregar Nuevo Examen
        </a>
    </div>

    <% if (examenes.length > 0) { %>
        <ul>
            <% examenes.forEach(function(examen) { %>
                <li style="margin-bottom: 10px;">
                    <strong><%= examen.tipo %></strong>: <%= examen.resultado %> 
                    <br><small>Fecha: <%= examen.fecha.toLocaleDateString() %></small>
                </li>
            <% }); %>
        </ul>
    <% } else { %>
        <p>Este paciente aún no tiene exámenes registrados.</p>
    <% } %>

    <hr>
    <button onclick="confirmarEliminacion('<%= paciente.id %>')" style="background: #dc3545; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;">
    Eliminar Paciente y Todo su Historial
    </button>

    <script>
        function confirmarEliminacion(id) {
            if (confirm('¿Estás seguro? Esta acción no se puede deshacer.')) {
                // Usamos backticks (`) para construir la URL de forma segura
                fetch(`/pacientes/${id}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = '/pacientes';
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('No se pudo conectar con el servidor para eliminar');
                });
            }
        }
    </script>
</body>
</html>