<!DOCTYPE html>
<html>
<head>
    <title>Detalle - <%= paciente.nombre %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
</head>
<body>
    <a href="/pacientes">← Volver al listado</a>
    
    <h1>Historia Clínica</h1>
    <section style="background: #eef2f3; padding: 15px; border-radius: 8px;">
        <p><strong>Nombre:</strong> <%= paciente.nombre %></p>
        <p><strong>Cédula:</strong> <%= paciente.cedula %></p>
        <p>
            <strong>Edad:</strong> 
            <span id="edadDisplay"><%= paciente.edad %> años</span>
            
            <button onclick="mostrarEditor()" id="btnEditar" style="background: none; border: none; color: #007bff; cursor: pointer; font-size: 0.8em; text-decoration: underline; margin-left: 10px;">
                (Editar)
            </button>

            <span id="editorEdad" style="display: none; margin-left: 10px;">
                <input type="number" id="inputEdad" value="<%= paciente.edad %>" style="width: 50px; border-radius: 4px; border: 1px solid #ccc;">
                <button onclick="actualizarEdad('<%= paciente.id %>')" style="background: #28a745; color: white; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer;">
                    Guardar
                </button>
                <button onclick="ocultarEditor()" style="background: #6c757d; color: white; border: none; border-radius: 3px; padding: 2px 8px; cursor: pointer;">
                    X
                </button>
            </span>
        </p>

        <script>
            function mostrarEditor() {
                document.getElementById('editorEdad').style.display = 'inline';
                document.getElementById('btnEditar').style.display = 'none';
                document.getElementById('edadDisplay').style.display = 'none';
            }

            function ocultarEditor() {
                document.getElementById('editorEdad').style.display = 'none';
                document.getElementById('btnEditar').style.display = 'inline';
                document.getElementById('edadDisplay').style.display = 'inline';
            }

            function actualizarEdad(id) {
                const edad = document.getElementById('inputEdad').value;
                
                fetch(`/pacientes/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ edad: edad })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        location.reload(); 
                    }
                })
                .catch(err => alert('Error al actualizar'));
            }
        </script>
        
        <p><strong>Fecha de Ingreso:</strong> <%= paciente.fechaIngreso.toLocaleDateString() %></p>
    </section>

    <hr>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Exámenes Realizados</h3>
        <a href="/pacientes/<%= paciente.id %>/examen/nuevo" 
           style="background: #007bff; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px; font-weight: bold;">
            + Agregar Nuevo Examen
        </a>
    </div>

    <% if (examenes.length > 0) { %>
        <ul>
            <% examenes.forEach(function(examen) { %>
                <li style="margin-bottom: 10px;">
                    <strong><%= examen.tipo %></strong>: <%= examen.resultado %> 
                    <br><small>Fecha: <%= examen.fecha.toLocaleDateString() %></small>
                </li>
            <% }); %>
        </ul>
    <% } else { %>
        <p>Este paciente aún no tiene exámenes registrados.</p>
    <% } %>

    <hr>
    <button onclick="confirmarEliminacion('<%= paciente.id %>')" style="background: #dc3545; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;">
    Eliminar Paciente y Todo su Historial
    </button>

    <script>
        function confirmarEliminacion(id) {
            if (confirm('¿Estás seguro? Esta acción no se puede deshacer.')) {
                fetch(`/pacientes/${id}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = '/pacientes';
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('No se pudo conectar con el servidor para eliminar');
                });
            }
        }
    </script>
</body>
</html>